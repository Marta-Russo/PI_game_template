<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/components/exp-lookit-games/discreteCatch.js - ember-lookit-frameplayer</title>
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="https://yui-s.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="https://yui-s.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">
<div id="doc">
    <div id="bd" class="yui3-g">
        <div class="yui3-u-1-5">
            <div id="docs-sidebar" class="sidebar apidocs">
              <h2 style="display:inline;">
              <div>
                <img style="float:right; vertical-align:middle;" src="../assets/css/logo.png" height="70">
                <span>Lookit<br> component<br> docs</span>
              </div>

              </h2>


              <div id="api-list">
                  <div id="api-tabview">
              
                    <div id="api-tabview-panel">
                        <h2 class="off-left">Collections</h2>
                        <ul id="api-modules" class="apis modules">
                            <li class="module-sidebar-components"><a href="../modules/components.html">components</a></li>
                            <li class="module-sidebar-exp-player"><a href="../modules/exp-player.html">exp-player</a></li>
                            <li class="module-sidebar-frames"><a href="../modules/frames.html">frames</a></li>
                            <li class="module-sidebar-games"><a href="../modules/games.html">games</a></li>
                            <li class="module-sidebar-mixins"><a href="../modules/mixins.html">mixins</a></li>
                            <li class="module-sidebar-randomizers"><a href="../modules/randomizers.html">randomizers</a></li>
                            <li class="module-sidebar-services"><a href="../modules/services.html">services</a></li>
                        </ul>
                        <h2 class="off-left">All elements</h2>
                              <div id="api-tabview-filter">
                      <input type="search" id="api-filter" placeholder="Type to filter">
                    </div>
                        <ul id="api-classes" class="apis classes">
                            <li><a href="../classes/Base.html">Base</a></li>
                            <li><a href="../classes/ButtonPressWindow.html">ButtonPressWindow</a></li>
                            <li><a href="../classes/DiscreteBounce.html">DiscreteBounce</a></li>
                            <li><a href="../classes/DiscreteButtonSpatial.html">DiscreteButtonSpatial</a></li>
                            <li><a href="../classes/DiscreteCatch.html">DiscreteCatch</a></li>
                            <li><a href="../classes/DiscreteCatchLift.html">DiscreteCatchLift</a></li>
                            <li><a href="../classes/Exp-exit-survey.html">Exp-exit-survey</a></li>
                            <li><a href="../classes/Exp-frame-base.html">Exp-frame-base</a></li>
                            <li><a href="../classes/Exp-frame-select.html">Exp-frame-select</a></li>
                            <li><a href="../classes/Exp-lookit-dialogue-page.html">Exp-lookit-dialogue-page</a></li>
                            <li><a href="../classes/Exp-lookit-exit-survey.html">Exp-lookit-exit-survey</a></li>
                            <li><a href="../classes/Exp-lookit-geometry-alternation.html">Exp-lookit-geometry-alternation</a></li>
                            <li><a href="../classes/Exp-lookit-geometry-alternation-open.html">Exp-lookit-geometry-alternation-open</a></li>
                            <li><a href="../classes/Exp-lookit-instructions.html">Exp-lookit-instructions</a></li>
                            <li><a href="../classes/Exp-lookit-mood-questionnaire.html">Exp-lookit-mood-questionnaire</a></li>
                            <li><a href="../classes/Exp-lookit-observation.html">Exp-lookit-observation</a></li>
                            <li><a href="../classes/Exp-lookit-preferential-looking.html">Exp-lookit-preferential-looking</a></li>
                            <li><a href="../classes/Exp-lookit-preview-explanation.html">Exp-lookit-preview-explanation</a></li>
                            <li><a href="../classes/Exp-lookit-story-page.html">Exp-lookit-story-page</a></li>
                            <li><a href="../classes/Exp-lookit-survey.html">Exp-lookit-survey</a></li>
                            <li><a href="../classes/Exp-lookit-text.html">Exp-lookit-text</a></li>
                            <li><a href="../classes/Exp-lookit-video.html">Exp-lookit-video</a></li>
                            <li><a href="../classes/Exp-lookit-video-assent.html">Exp-lookit-video-assent</a></li>
                            <li><a href="../classes/Exp-lookit-video-consent.html">Exp-lookit-video-consent</a></li>
                            <li><a href="../classes/Exp-player.html">Exp-player</a></li>
                            <li><a href="../classes/Exp-video-config.html">Exp-video-config</a></li>
                            <li><a href="../classes/Exp-video-config-quality.html">Exp-video-config-quality</a></li>
                            <li><a href="../classes/Exp-video-consent.html">Exp-video-consent</a></li>
                            <li><a href="../classes/Exp-video-preview.html">Exp-video-preview</a></li>
                            <li><a href="../classes/Expand-assets.html">Expand-assets</a></li>
                            <li><a href="../classes/ExpFrameGamesComponent.html">ExpFrameGamesComponent</a></li>
                            <li><a href="../classes/Full-screen.html">Full-screen</a></li>
                            <li><a href="../classes/Game.html">Game</a></li>
                            <li><a href="../classes/Media-reload.html">Media-reload</a></li>
                            <li><a href="../classes/Permute.html">Permute</a></li>
                            <li><a href="../classes/Random-parameter-set.html">Random-parameter-set</a></li>
                            <li><a href="../classes/Select.html">Select</a></li>
                            <li><a href="../classes/Session-record.html">Session-record</a></li>
                            <li><a href="../classes/Utils
              Shared Utility class for project static methods and constants.html">Utils
              Shared Utility class for project static methods and constants</a></li>
                            <li><a href="../classes/Video-record.html">Video-record</a></li>
                            <li><a href="../classes/video-recorder.html">video-recorder</a></li>
                        </ul>
                    </div>
              
                  </div>
              </div>
            </div>
        </div>
        <div class="yui3-u-4-5">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: app/components/exp-lookit-games/discreteCatch.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
 * Developed by Gleb Iakovlev on 5/3/19 9:09 PM.
 * Last modified 4/29/19 9:36 PM.
 * Copyright (c) Cognoteq Software Solutions 2019.
 * All rights reserved
 */

import Base from &#x27;./base&#x27;;
/**
 *
 * @submodule games
 *
 */
const TOTAL_ROUNDS = 48;
let basket = {};
let ball = {};
let obstructions = []; // Possible obstructions array
let targetStars = {}; // Start location (shows upon reaching the rim on basket )
let initialTime = 0; // initial time for current game trial
let hArray = [];
let Tf = 0.72; // Time Flight for trajectory
let Height = 0.8; // Current trajectory height
let obstrArr = []; // Current obstructions  array
let jitterT = 0;
let radiusRim = 0.1; //Rim size on basket
let obstructionsNum = 0; // Current number of obstructions (randomized each trial)
let consecutiveCounts = 0;  // Calculate number of consecutive successful attempts
let startTime = 0;

const TRAVEL_TIME = 1.5;

// Media arrays for loading
let sounds = [];
let soundURLs = [];
let imageURls = [];
let images = [];
let obstructionsURLs = [];
let obstructionImages = [];

// Media mapping as Enum
const gameSound = {
    START:0,
    CATCH:1,
    FAIL:2
};
const gameImage = {
    PADDLE: 0,
    BALL: 1,
    STARS: 2,
    BALLBOX: 3

};

/**
 * Main implementation of catch game.
 * The user will operate with paddle to catch the ball started
 * from ball box. The trajectory is randomized with various values in trajectories array
 * Number of obstructions currently randomized from 0 to 3 obstructions shown
 * @class DiscreteCatch
 * @extends Base
 */
export default class DiscreteCatch extends Base {
  /**
   * @method constructor
   * @constructor constructor
   * @param context
   * @param document
   */
  constructor(context, document) {
    super(context, document);
    super.setMaxTrials(TOTAL_ROUNDS);
    soundURLs = [super.Utils.rattleSound,super.Utils.goodCatchSound,super.Utils.failcatchSound];
    imageURls = [super.Utils.ironBasket,super.Utils.gear,super.Utils.basketStarsImage,super.Utils.robotImage];
    obstructionsURLs = [super.Utils.obstruction1, super.Utils.obstruction2, super.Utils.obstruction3];

  }


  /**
   * Main point to start the game.
   * Initialize static parameters and preload sounds here
   * @method init
   */
  init() {
    hArray = super.generateHeights();
    obstrArr  = super.uniformArr([0,1,2,3]);
    super.fillAudioArray(soundURLs,sounds);
    super.fillImageArray(imageURls,images);
    super.fillImageArray(obstructionsURLs,obstructionImages);

    basket = {
      positions:[],
      times:[],
      velocity: super.Utils.paddleSpeed,
      paddleLastMovedMillis: 0
    };

    document.addEventListener(&quot;mousemove&quot;,  super.onMouseMove);
    sounds[gameSound.START].addEventListener(&#x27;playing&#x27;, function () {
      startTime = 0;
      initialTime = new Date().getTime();

    });
    sounds[gameSound.START].addEventListener(&#x27;onloadeddata&#x27;, this.initGame(), false);
    super.init();

  }


  /**
   * Initialize each game round with initial object parameters
   * Randomize number of obstructions
   * Wait for start sound and start the main game loop
   * @method initGame
   */
  initGame() {
    jitterT = super.trialStartTime();
    initialTime =0;
    super.createPaddleBox();
    basket = super.basketObject(basket);
    obstructionsNum = obstrArr[super.currentRounds];
    ball = super.ballObject();
    // Generate array of obstruction objects
    obstructions = Array(obstructionsNum).fill({}).map((value, index) =&gt;

      ( this.getObstruction(index+1))
    );


    startTime = new Date().getTime();




    super.initGame();

  }


  /**
   * Obstruction object with coordinates
   * @method getObstruction
   * @param obstructionIndex
   * @return {{imageURL: *, position: {x: number, y: number}, dimensions: {width: number, height: number}}}
   */
  getObstruction(obstructionIndex = 1) {

    let leftBorder = (1 - 0.105 * obstructionIndex) * super.Utils.SCALE ;
    let topBorder = (0.964) * super.Utils.SCALE;
    let rightBorder = 1.18  * super.Utils.SCALE;
    let downBorder = (1.592) * super.Utils.SCALE;
    return {
      position: {x: leftBorder, y: topBorder},
      dimensions: {width: rightBorder - leftBorder, height: downBorder - topBorder},
      image: obstructionImages[obstructionIndex-1]
    };

  }

  /**
   * trajectory  : 1,2,3 ( Time when ball hits the basket at 500,600,700 ms )
   * @method dataCollection
   */
  dataCollection() {
    super.dataCollection();
    let exportData = {
      game_type: &#x27;discreteCatch&#x27;,
      trajectory: hArray[super.currentRounds],
      ball_position_x: ball.position.x / this.canvas.width ,
      ball_position_y:  (this.canvas.height - ball.position.y)/this.canvas.height,
      paddle_position_x: basket.position.x/this.canvas.width,
      paddle_position_y: (this.canvas.height - basket.position.y)/this.canvas.height,
      trial: super.currentRounds,
      timestamp: super.getElapsedTime(initialTime)

    };
    if(ball.state === &#x27;hit&#x27; || ball.state === &#x27;fall&#x27;) {
      super.storeData(exportData);
    }
  }




  /**
   * Check if ball reaches the target
   * @method collisionDetection
   * @return {boolean}
   */
  collisionDetection() {

    let basketPrevPosition = 0;
    if(basket.positions.length &gt;2){

      basketPrevPosition = this.canvas.height - (basket.positions[basket.positions.length-2])*this.canvas.height;
    }

    if(ball.positions.length &gt;2 &amp;&amp; ball.positions[ball.positions.length-2] &lt;= basketPrevPosition &amp;&amp; ball.position.y &gt; basket.position.y){
      if (ball.position.x &gt;= basket.position.x &amp;&amp; ball.position.x &lt;=  basket.position.x +  basket.dimensions.width ) {
        let margin = radiusRim / 4;
        ball.hitstate = &#x27;good&#x27;;

        if (ball.position.x &gt; (1.3301 - margin) * super.Utils.SCALE &amp;&amp; ball.position.x &lt; (1.3301 + margin) * super.Utils.SCALE) {

          ball.hitstate = &#x27;very good&#x27;;
        }
        return true;
      }
    }

    return false;

  }

  /**
   * Update location of the basket stars(symbolize that user reached the target) with the basket location
   * @method starsLocationUpdate
   */
  starsLocationUpdate() {

    targetStars = {

      position: {x: basket.position.x + 0.01* super.Utils.SCALE , y: basket.position.y - 0.2* super.Utils.SCALE},
      dimensions: {width: 0.14*super.Utils.SCALE, height: 0.2*super.Utils.SCALE}
    };

  }


  /**
   * Draw initial ball box object
   * @method createLauncher
   * @param {image}  BallBox image
   */
  createLauncher(image) {

    let leftBorder = (0.05) * super.Utils.SCALE;
    let topBorder = (1.1471 )* super.Utils.SCALE;
    this.ctx.drawImage(image, leftBorder, topBorder, basket.dimensions.height*3, basket.dimensions.height*3);


  }


  /**
   * Main loop of the game.
   * Set initial position of the ball in a box and starting  sound .
   * After that  start ball trajectory.
   * If ball hits the target or missed the target wait util user places the paddle to starting position.
   * Increase the score if ball hits the target.
   * @method loop
   */
  loop() {
    super.loop();
    super.generateTrajectoryParams(hArray,Height,Tf);
    this.createLauncher(images[gameImage.BALLBOX]);
    let paddleBoxColor = super.Utils.blueColor;
    if(ball.state === &#x27;start&#x27;){
      ball = this.ballObject();

      if (startTime &gt; 0 &amp;&amp;  !super.paddleIsMoved(basket) &amp;&amp; super.getElapsedTime(startTime) &gt; TRAVEL_TIME ){
        sounds[gameSound.START].play();
      }

      if(initialTime &gt; 0 &amp;&amp; super.paddleIsMoved(basket)){
        initialTime = new Date().getTime();
        paddleBoxColor = super.Utils.redColor;
      }

      if (initialTime &gt; 0 &amp;&amp; super.getElapsedTime(initialTime) &gt; jitterT) {
        sounds[gameSound.START].pause();
        sounds[gameSound.START].currentTime = 0;
        initialTime = new Date().getTime();
        ball.state = &#x27;fall&#x27;;
      }

    }


    if(ball.state === &#x27;fall&#x27;){
      if(initialTime &gt; 0 &amp;&amp; super.getElapsedTime(initialTime) &lt;= TRAVEL_TIME) {
        ball.positions.push(ball.position.y);
        super.trajectory(ball, initialTime);
      }

      if(initialTime &gt; 0 &amp;&amp; super.ballIsOnFloor(ball)) {
        ball.state = &#x27;hit&#x27;;
      }


     // super.drawBall(ball,images[gameImage.BALL]);
    }


    let hitTheTarget = this.collisionDetection();
    let hitTheWall = super.wallCollision(ball);

    if((hitTheTarget || hitTheWall) &amp;&amp; ball.state === &#x27;fall&#x27;){

      ball.state = &#x27;hit&#x27;;
    }


    if (ball.state === &#x27;hit&#x27;) {


      if (ball.hitstate === &#x27;very good&#x27; || ball.hitstate === &#x27;good&#x27;) {
        super.increaseScore();
        consecutiveCounts++;
        sounds[gameSound.CATCH].play();
        ball.radius = 0;

      }else{

        sounds[gameSound.FAIL].play();
        consecutiveCounts = 0;
      }


      ball.state = &#x27;done&#x27;;

    }


    if(ball.state === &#x27;done&#x27;){


      if (ball.hitstate === &#x27;very good&#x27;) {
        this.starsLocationUpdate();
        super.drawImageObject(targetStars,images[gameImage.STARS]);

      }

      // Remove ball and show in the starting point,
      //User should set the paddle to initial position , call stop after that
      super.paddleAtZero(basket,false);

    }

    super.drawBall(ball,images[gameImage.BALL]);
    obstructions.forEach(obstruction =&gt; super.drawImage(obstruction, obstruction.image));
    this.basketObject(basket);
    super.createPaddleBox(paddleBoxColor,true);
    super.paddleMove(basket,initialTime,ball);
    super.drawImageObject(basket,images[gameImage.PADDLE]);

  }




}

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
