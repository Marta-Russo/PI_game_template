<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/components/exp-lookit-games/discreteButtonSpatial.js - ember-lookit-frameplayer</title>
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="https://yui-s.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="https://yui-s.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">
<div id="doc">
    <div id="bd" class="yui3-g">
        <div class="yui3-u-1-5">
            <div id="docs-sidebar" class="sidebar apidocs">
              <h2 style="display:inline;">
              <div>
                <img style="float:right; vertical-align:middle;" src="../assets/css/logo.png" height="70">
                <span>Lookit<br> component<br> docs</span>
              </div>

              </h2>


              <div id="api-list">
                  <div id="api-tabview">
              
                    <div id="api-tabview-panel">
                        <h2 class="off-left">Collections</h2>
                        <ul id="api-modules" class="apis modules">
                            <li class="module-sidebar-components"><a href="../modules/components.html">components</a></li>
                            <li class="module-sidebar-exp-player"><a href="../modules/exp-player.html">exp-player</a></li>
                            <li class="module-sidebar-frames"><a href="../modules/frames.html">frames</a></li>
                            <li class="module-sidebar-games"><a href="../modules/games.html">games</a></li>
                            <li class="module-sidebar-mixins"><a href="../modules/mixins.html">mixins</a></li>
                            <li class="module-sidebar-randomizers"><a href="../modules/randomizers.html">randomizers</a></li>
                            <li class="module-sidebar-services"><a href="../modules/services.html">services</a></li>
                        </ul>
                        <h2 class="off-left">All elements</h2>
                              <div id="api-tabview-filter">
                      <input type="search" id="api-filter" placeholder="Type to filter">
                    </div>
                        <ul id="api-classes" class="apis classes">
                            <li><a href="../classes/Base.html">Base</a></li>
                            <li><a href="../classes/ButtonPressWindow.html">ButtonPressWindow</a></li>
                            <li><a href="../classes/DiscreteBounce.html">DiscreteBounce</a></li>
                            <li><a href="../classes/DiscreteButtonSpatial.html">DiscreteButtonSpatial</a></li>
                            <li><a href="../classes/DiscreteCatch.html">DiscreteCatch</a></li>
                            <li><a href="../classes/DiscreteCatchLift.html">DiscreteCatchLift</a></li>
                            <li><a href="../classes/Exp-exit-survey.html">Exp-exit-survey</a></li>
                            <li><a href="../classes/Exp-frame-base.html">Exp-frame-base</a></li>
                            <li><a href="../classes/Exp-frame-select.html">Exp-frame-select</a></li>
                            <li><a href="../classes/Exp-lookit-dialogue-page.html">Exp-lookit-dialogue-page</a></li>
                            <li><a href="../classes/Exp-lookit-exit-survey.html">Exp-lookit-exit-survey</a></li>
                            <li><a href="../classes/Exp-lookit-geometry-alternation.html">Exp-lookit-geometry-alternation</a></li>
                            <li><a href="../classes/Exp-lookit-geometry-alternation-open.html">Exp-lookit-geometry-alternation-open</a></li>
                            <li><a href="../classes/Exp-lookit-instructions.html">Exp-lookit-instructions</a></li>
                            <li><a href="../classes/Exp-lookit-mood-questionnaire.html">Exp-lookit-mood-questionnaire</a></li>
                            <li><a href="../classes/Exp-lookit-observation.html">Exp-lookit-observation</a></li>
                            <li><a href="../classes/Exp-lookit-preferential-looking.html">Exp-lookit-preferential-looking</a></li>
                            <li><a href="../classes/Exp-lookit-preview-explanation.html">Exp-lookit-preview-explanation</a></li>
                            <li><a href="../classes/Exp-lookit-story-page.html">Exp-lookit-story-page</a></li>
                            <li><a href="../classes/Exp-lookit-survey.html">Exp-lookit-survey</a></li>
                            <li><a href="../classes/Exp-lookit-text.html">Exp-lookit-text</a></li>
                            <li><a href="../classes/Exp-lookit-video.html">Exp-lookit-video</a></li>
                            <li><a href="../classes/Exp-lookit-video-assent.html">Exp-lookit-video-assent</a></li>
                            <li><a href="../classes/Exp-lookit-video-consent.html">Exp-lookit-video-consent</a></li>
                            <li><a href="../classes/Exp-player.html">Exp-player</a></li>
                            <li><a href="../classes/Exp-video-config.html">Exp-video-config</a></li>
                            <li><a href="../classes/Exp-video-config-quality.html">Exp-video-config-quality</a></li>
                            <li><a href="../classes/Exp-video-consent.html">Exp-video-consent</a></li>
                            <li><a href="../classes/Exp-video-preview.html">Exp-video-preview</a></li>
                            <li><a href="../classes/Expand-assets.html">Expand-assets</a></li>
                            <li><a href="../classes/ExpFrameGamesComponent.html">ExpFrameGamesComponent</a></li>
                            <li><a href="../classes/Full-screen.html">Full-screen</a></li>
                            <li><a href="../classes/Game.html">Game</a></li>
                            <li><a href="../classes/Media-reload.html">Media-reload</a></li>
                            <li><a href="../classes/Permute.html">Permute</a></li>
                            <li><a href="../classes/Random-parameter-set.html">Random-parameter-set</a></li>
                            <li><a href="../classes/Select.html">Select</a></li>
                            <li><a href="../classes/Session-record.html">Session-record</a></li>
                            <li><a href="../classes/Utils
              Shared Utility class for project static methods and constants.html">Utils
              Shared Utility class for project static methods and constants</a></li>
                            <li><a href="../classes/Video-record.html">Video-record</a></li>
                            <li><a href="../classes/video-recorder.html">video-recorder</a></li>
                        </ul>
                    </div>
              
                  </div>
              </div>
            </div>
        </div>
        <div class="yui3-u-4-5">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: app/components/exp-lookit-games/discreteButtonSpatial.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
 * Developed by Gleb Iakovlev on 5/3/19 9:09 PM.
 * Last modified 4/29/19 8:18 PM.
 * Copyright (c) Cognoteq Software Solutions 2019.
 * All rights reserved
 */

import Base from &#x27;./base&#x27;;

/**
 *
 * @submodule games
 *
 */
const INITIAL_DELAY = 2.5;
let ball = {};
let targets = [];
let pressed = {};
let keys = [&#x27;y&#x27;, &#x27;g&#x27;, &#x27;v&#x27;]; //Keyboard keys for upper,middle and lower windows
let currentTargetIndex = 0;
let initialTime = 0; // initial time for current game trial
let initVmatrix = []; //Initial velocity matrix uniformly distributed and randomized
let obstructions = []; // Array of possible obstructions parameters
let jitterT = 0; // Time jitter (variates from 500 ms to 1500 ms), time between sound start and ball starting to fly
let startTime = 0; // start of the game to wait before music playing

// Media arrays for loading
let windowImgs = [];
let windowImageURLS = [];
let obstrImgs = [];
let obstrImageURLS = [];
let sounds = [];
let soundURLs = [];
let imageURls = [];
let images = [];

// Media mapping as Enum
const gameSound = {
    START: 0,
    LAUNCH: 1,
    CATCH: 2,
    FAIL: 3
};

const gameImage = {
    LAUNCHER: 0,
    BALL: 1,
    TARGET: 2,
    window: {
      WINDOW1: 0,
      WINDOW2: 1,
      WINDOW3: 2
    },
    shuttle: {
      SMALL: 0,
      MIDDLE: 1,
      LARGE: 2
    }
};



/**
 * The user will operate with keyboard keys to predict which ball trajectory will hit which window
 * in the obstruction (shuttle).
 * The trajectory is randomized with various values in trajectories array
 * @class DiscreteButtonSpatial
 * @extends Base
 */
export default class DiscreteButtonSpatial extends Base {

  /**
   * @method constructor
   * @constructor constructor
   * @param context
   * @param document
   */
  constructor(context, document) {
    super(context, document);
    imageURls = [super.Utils.slimeMonster, super.Utils.slimeBall, super.Utils.splat];
    windowImageURLS = [super.Utils.openWindowYellow, super.Utils.openWindowGreen, super.Utils.openWindowViolet];
    obstrImageURLS = [super.Utils.shuttleNarrow, super.Utils.shuttle, super.Utils.shuttleWide];
    soundURLs = [super.Utils.monsterGrowl, super.Utils.monsterLaunch, super.Utils.good3MouseSound, super.Utils.bad3MouseSound];

  }

  /**
   * Get Current window position and align it according to possible obstruction (shuttle) size
   * @method getWindow
   * @param index of the target (shuttle) in array of objects
   * @return {{image: *, position: {x: number, y: number}, radius: number, dimensions: {width: number, height: number}}}
   */
  getWindow(index) {
    index = index + 1;
    let top = 1.12;
    let leftBorder = (1.5450) * super.Utils.SCALE;
    let windowPosition = gameImage.window.WINDOW1;
    switch (index) {

      case 2:

        top = 1.25;
        windowPosition = gameImage.window.WINDOW2;
        leftBorder = (1.555) * super.Utils.SCALE;

        break;

      case 3:

        top = 1.39;
        windowPosition = gameImage.window.WINDOW3;
        leftBorder = (1.555) * super.Utils.SCALE;
        break;

    }

    let topBorder = top * super.Utils.SCALE;

    return {
      dimensions: {width: 0.10238 * super.Utils.SCALE, height: 0.075 * super.Utils.SCALE},
      position: {
        x: leftBorder,
        y: topBorder
      },
      radius: 0.00956 * super.Utils.SCALE,
      image: windowImgs[windowPosition]
    };

  }



  /**
   * Draw target  according to coordinates
   * @method createShuttle
   */
  createShuttle() {

    let leftBorder = 0.798 * super.Utils.SCALE;
    let topBorder = 0.78 * super.Utils.SCALE;

    let targetParams = {

      dimensions: {width: 1.19 * super.Utils.SCALE, height: 1.135 * super.Utils.SCALE},
      position: {x: leftBorder, y: topBorder}
    };


    this.getShuttle(targetParams);

  }


  /**
   *
   * Get shuttle image from sources and display according to position parameters
   * @param targetParams target position parameters
   * @method getShuttle
   */
  getShuttle(targetParams) {

    let index = obstructions[super.currentRounds]; // Get current shuttle case
    let shuttle = {};
    targetParams.position.x = {};

    switch (index) {

      case 2:
        targetParams.position.x = 0.798 * super.Utils.SCALE;
        shuttle = obstrImgs[gameImage.shuttle.MIDDLE];
        break;
      case 3:
        targetParams.position.x = 0.77 * super.Utils.SCALE;
        shuttle = obstrImgs[gameImage.shuttle.LARGE];
        break;
      default:
        targetParams.position.x = 0.81 * super.Utils.SCALE;
        shuttle = obstrImgs[gameImage.shuttle.SMALL];
        break;


    }

    super.drawImageObject(targetParams, shuttle);

  }


  /**
   * Create the window in the target
   * @method createTargetWindow
   * @param target
   */
  createWindow(target) {

    super.drawImageObject(target, target.image);

  }

  /**
   * Main point to start the game.
   * Initialize static parameters and preload sounds here
   * @method init
   */
  init() {
    startTime = new Date().getTime();
    initVmatrix = super.uniformArr([1, 2, 3]);
    obstructions = super.uniformArr([1, 2, 3]);

    super.fillAudioArray(soundURLs,sounds);
    super.fillImageArray(imageURls,images);
    super.fillImageArray(windowImageURLS,windowImgs);
    super.fillImageArray(obstrImageURLS,obstrImgs);


    sounds[gameSound.START].addEventListener(&#x27;onloadeddata&#x27;, this.initGame(), false);
    sounds[gameSound.START].addEventListener(&#x27;playing&#x27;, function () {
      initialTime = new Date().getTime();
    });
    super.init();
  }


  /**
   * Initialize each game round with initial object parameters
   * Randomize number of obstructions (obstructions)
   * Reset the sounds sources for older browser versions
   * Wait for start sound and start the main game loop
   * @method initGame
   */
  initGame() {
    initialTime = 0;
    pressed = Array(3).fill(false);
    jitterT = super.trialStartTime();
    ball = {
      position: {x: 0, y: 0},
      radius: 0.02385 * super.Utils.SCALE,
      restitution: super.Utils.restitution,
      timeReached: new Date().getTime()

    };

    ball = super.ballObject();

    if(super.currentRounds &gt; 0 ){
      sounds[gameSound.START].play();
    }

    targets = Array(3).fill({}).map((_, index) =&gt;

      (this.getWindow(index))
    );
    if(super.getElapsedTime(startTime) &gt;= 2) {
      sounds[gameSound.START].play();
    }

    super.initGame();

  }


  /**
   * Show the ball location in window.
   * Center the ball location.
   * @method showBallLocation
   * @param index Index of the object in array
   */
  showBallLocation(index) {

    //Put the ball in the center of target once it hits window constraints
    let target = targets[index];

    let splat = {

      dimensions: {width: 0.09645 * super.Utils.SCALE, height: 0.09107 * super.Utils.SCALE},
      position: {x: target.position.x - 0.0238 * super.Utils.SCALE, y: target.position.y}
    };

    super.drawImageObject(splat, images[gameImage.TARGET]);


  }


  /**
   * Set appropriate index value in pressed array, according to index of the key pressed
   * @method  keyDownHandler
   * @param e {object} event
   */
  keyDownHandler(e) {

    if (ball.state !== &#x27;hit&#x27; &amp;&amp; ball.state !== &#x27;hit target&#x27;) {
      pressed = pressed.fill(false);
      pressed = pressed.map((val, index) =&gt; keys[index] === e.key );
    }

  }

  /**
   * Display launcher
   * @method discreteLauncher
   * @param image of the Launcher
   */
  discreteLauncher(image) {


    let leftBorder = (0.701) * super.Utils.SCALE;
    let topBorder = (1.3671) * super.Utils.SCALE;

    let launcher = {

      dimensions: {width: 0.19 * super.Utils.SCALE, height: 0.273 * super.Utils.SCALE},
      position: {x: leftBorder, y: topBorder}
    };
    super.drawImageObject(launcher, image);


  }


  /**
   * Main loop of the game
   * Set initial position of the ball in a box and starting sound .
   * After that  start ball trajectory.
   * If ball hits the target or missed the target(window) show the ball in the window and selected window
   * clicked by user (indicate the window background with color).
   * Increase the score if ball hits the window.
   * Move the ball to initial position.
   * Wait for some time until rattle sound played.
   * @method keyDownHandler
   */
  loop() {
    super.loop();
    super.generateTrajectoryParamsDiscreteSpatial(initVmatrix);
    this.discreteLauncher(images[gameImage.LAUNCHER]);

    let index = pressed.findIndex(item =&gt; item !== false);

    if(initialTime === 0 &amp;&amp; super.currentRounds === 0  &amp;&amp; super.getElapsedTime(startTime) &gt;= INITIAL_DELAY) {

      sounds[gameSound.START].play();

    }

    if (ball.state === &#x27;start&#x27;) {
      super.moveBallToStart(ball, images[gameImage.BALL]);
      if (initialTime &gt; 0 &amp;&amp; super.getElapsedTime(initialTime) &gt; jitterT) {
        sounds[gameSound.START].pause();
        sounds[gameSound.LAUNCH].play();
        initialTime = new Date().getTime();
        ball.state = &#x27;fall&#x27;;

      }


    }


    if (ball.state === &#x27;fall&#x27;) {

      super.trajectory(ball, initialTime);
      super.drawBall(ball, images[gameImage.BALL]);
      if (super.getElapsedTime(initialTime) &gt;= 0.5) {

        ball.state = &#x27;hit house&#x27;;
      }


    }

    if ((ball.state === &#x27;fall&#x27; || ball.state === &#x27;hit house&#x27;) &amp;&amp; index &gt;= 0) {

      ball.state = &#x27;hit&#x27;;

    }


    if (ball.state === &#x27;hit house&#x27;) {
      if (super.getElapsedTime(initialTime) &gt;= 2.5) {
        initialTime = new Date().getTime();
        ball.state = &#x27;hit&#x27;;
      }

    }


    if (ball.state === &#x27;hit&#x27;) {
      if (index &gt;= 0) {
        let target = targets[index];
        this.createWindow(target);
        this.showWindow(index);
      }
      // Check if current index of the pressed item corresponds to the actual target index
      if (index === currentTargetIndex) {

        sounds[gameSound.CATCH].play();

      } else {
        sounds[gameSound.FAIL].play();
      }


      ball.state = &#x27;hit target&#x27;;

    }

    this.createShuttle();

    if (ball.state === &#x27;hit target&#x27;) {
      if (index &gt;= 0) {
        let target = targets[index];
        this.createWindow(target);
        this.showWindow(index);
      }
      if (super.getElapsedTime(initialTime) &gt;= 3) {
        super.finishGame(false);
      }


    }


  }


  /**
   * Show selected window
   * @method showWindow
   * @param index
   */
  showWindow(index) {
    let pressed_target = targets[index];

    if (pressed_target) {
      this.createWindow(pressed_target);

    }

    let indexArr = [2, 1, 0];
    currentTargetIndex = indexArr[initVmatrix[super.currentRounds] - 1];

    //Show ball only on button press
    if (index &gt;= 0) {
      this.showBallLocation(currentTargetIndex);
    }
  }

  /**
   * @method dataCollection
   */
  dataCollection() {
    super.dataCollection();
    //Set  0,1,2,3,4,5,6  as buttons pressed values (0:  no buttons pressed, 1 : upper button pressed  , 2: middle
    // button pressed , 3 : down button pressed, 4 : upper button correct , 5 : middle button correct , 6 : down
    // button correct

    let target_state =  0;
    let index = pressed.findIndex(item =&gt; item !== false);
    if(keys[index] !== undefined){
      target_state = index + 1;

      if(index === currentTargetIndex){
        target_state = target_state +3;
      }
    }


    let exportData = {
      game_type: &#x27;discreteButtonSpatial&#x27;,
      ball_position_x: ball.position.x,
      ball_position_y: ball.position.y,
      key_pressed: target_state,
      trial: super.currentRounds,
      timestamp: new Date().getTime()

    };

    super.storeData(exportData);

  }

}

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
